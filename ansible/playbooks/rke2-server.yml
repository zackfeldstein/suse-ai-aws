---
- name: Create RKE2 config directory
  file:
    path: /etc/rancher/rke2
    state: directory
    mode: '0755'

- name: Create RKE2 server configuration
  copy:
    content: |
      write-kubeconfig-mode: "0644"
      tls-san:
        - "{{ ansible_host }}"
        - "{{ private_ip }}"
        - "{{ rancher_domain }}"
      cluster-cidr: "{{ cluster_cidr }}"
      service-cidr: "{{ service_cidr }}"
      cluster-dns: "10.43.0.10"
    dest: /etc/rancher/rke2/config.yaml
    mode: '0600'

- name: Download RKE2 installation script
  get_url:
    url: https://get.rke2.io
    dest: /tmp/rke2-install.sh
    mode: '0755'

- name: Install RKE2 server
  shell: |
    INSTALL_RKE2_VERSION="{{ rke2_version }}" \
    INSTALL_RKE2_TYPE="server" \
    /tmp/rke2-install.sh
  args:
    creates: /usr/local/bin/rke2

- name: Enable and start rke2-server service
  systemd:
    name: rke2-server
    enabled: yes
    state: started

- name: Wait for RKE2 to be ready (local check)
  wait_for:
    port: 6443
    host: 127.0.0.1
    delay: 30
    timeout: 300

- name: Create kubectl symlink
  file:
    src: /var/lib/rancher/rke2/bin/kubectl
    dest: /usr/local/bin/kubectl
    state: link

- name: Set KUBECONFIG environment for all users
  lineinfile:
    path: /etc/environment
    line: 'KUBECONFIG=/etc/rancher/rke2/rke2.yaml'
    create: yes

- name: Get node token for future agent nodes
  slurp:
    src: /var/lib/rancher/rke2/server/node-token
  register: node_token

- name: Display node token
  debug:
    msg: "Node token: {{ node_token.content | b64decode | trim }}"

- name: Install local-path storage provisioner
  shell: |
    KUBECONFIG=/etc/rancher/rke2/rke2.yaml /var/lib/rancher/rke2/bin/kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.24/deploy/local-path-storage.yaml

- name: Wait for local-path-provisioner to be ready
  shell: |
    KUBECONFIG=/etc/rancher/rke2/rke2.yaml /var/lib/rancher/rke2/bin/kubectl wait --for=condition=available --timeout=300s deployment/local-path-provisioner -n local-path-storage

- name: Set local-path as default storage class
  shell: |
    KUBECONFIG=/etc/rancher/rke2/rke2.yaml /var/lib/rancher/rke2/bin/kubectl patch storageclass local-path -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

- name: Verify RKE2 installation
  shell: KUBECONFIG=/etc/rancher/rke2/rke2.yaml /var/lib/rancher/rke2/bin/kubectl get nodes
  register: kubectl_nodes
  become: no

- name: Display cluster status
  debug:
    msg: "{{ kubectl_nodes.stdout_lines }}"

- name: Verify storage class configuration
  shell: KUBECONFIG=/etc/rancher/rke2/rke2.yaml /var/lib/rancher/rke2/bin/kubectl get storageclass
  register: storage_classes
  become: no

- name: Display storage classes
  debug:
    msg: "{{ storage_classes.stdout_lines }}"
